<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modern Chat App</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  body { display: flex; height: 100vh; background-color: #e5ddd5; }

  /* Auth forms */
  #auth { position: absolute; top:0; left:0; right:0; bottom:0; background: #f0f0f0; display:flex; justify-content:center; align-items:center; z-index: 100; }
  #auth form { background: white; padding: 30px; border-radius: 10px; width: 300px; box-shadow: 0 0 10px rgba(0,0,0,0.2); display:flex; flex-direction:column; gap: 15px; }
  #auth input, #auth select { padding:10px; border-radius:5px; border:1px solid #ccc; width:100%; }
  #auth button { padding:10px; border:none; border-radius:5px; background:#4CAF50; color:white; cursor:pointer; }
  #auth button:hover { background:#45a049; }
  #auth .switch { text-align:center; font-size:14px; cursor:pointer; color:#555; }

  /* Toggle sidebar button for mobile */
  #toggleUsers { display:none; position: absolute; top: 15px; left: 15px; background-color: #4CAF50; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 18px; z-index: 11; }

  /* Sidebar Users */
  #users { width: 280px; background-color: #f0f0f0; display: flex; flex-direction: column; border-right: 1px solid #ccc; overflow-y: auto; }
  #users h2 { padding: 15px; background-color: #4CAF50; color: white; text-align: center; }
  .user { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #ddd; }
  .user:hover { background-color: #e0e0e0; }
  .user .info { display: flex; flex-direction: column; }
  .user .username { font-weight: bold; font-size: 16px; }
  .user .state { font-size: 12px; color: #555; }
  .user .unread { background-color: red; color: white; font-size: 12px; font-weight: bold; padding: 2px 6px; border-radius: 50%; }
  .user .online { width: 10px; height: 10px; background-color: #4CAF50; border-radius: 50%; margin-left: 8px; }

  /* Chat Window */
  #chat { flex: 1; display: flex; flex-direction: column; }
  #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
  .message { max-width: 70%; padding: 10px 14px; border-radius: 15px; word-wrap: break-word; position: relative; }
  .sent { background-color: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 0; }
  .received { background-color: white; align-self: flex-start; border-bottom-left-radius: 0; }
  .timestamp { font-size: 10px; color: #888; margin-top: 3px; text-align: right; }

  /* Typing indicator */
  #typing { font-size: 12px; color: #555; padding-left:10px; }

  /* Input Bar */
  #input { display: flex; padding: 10px; background-color: #f0f0f0; border-top: 1px solid #ccc; }
  #input input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ccc; outline: none; margin-right: 10px; }
  #input button { padding: 12px 20px; border: none; border-radius: 20px; background-color: #4CAF50; color: white; cursor: pointer; transition: background 0.2s; }
  #input button:hover { background-color: #45a049; }

  /* Scrollbar */
  #messages::-webkit-scrollbar, #users::-webkit-scrollbar { width: 6px; }
  #messages::-webkit-scrollbar-thumb, #users::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

  /* Responsive */
  @media(max-width: 768px){
    #users { width: 60%; position: absolute; z-index: 10; height: 100%; left: -100%; transition: left 0.3s; }
    #users.show { left: 0; }
    #toggleUsers { display:block; }
  }
</style>
</head>
<body>

<!-- Auth forms -->
<div id="auth">
  <form id="loginForm">
    <h3>Login</h3>
    <input type="text" id="loginUsername" placeholder="Username" required>
    <input type="password" id="loginPassword" placeholder="Password" required>
    <button type="submit">Login</button>
    <div class="switch" onclick="showRegister()">Don't have an account? Register</div>
  </form>

  <form id="registerForm" style="display:none;">
    <h3>Register</h3>
    <input type="text" id="regUsername" placeholder="Username" required>
    <input type="password" id="regPassword" placeholder="Password" required>
    <select id="regGender" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
    <input type="text" id="regState" placeholder="State" required>
    <button type="submit">Register</button>
    <div class="switch" onclick="showLogin()">Already have an account? Login</div>
  </form>
</div>

<button id="toggleUsers">â˜°</button>

<div id="users">
  <h2>Contacts</h2>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="typing"></div>
  <div id="input">
    <input type="text" id="messageInput" placeholder="Type a message... ðŸ˜Š" />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
<script>
const socket = io("http://localhost:5000");
let currentUser = null;
let selectedUser = null;
let users = [];

// Toggle sidebar on mobile
const toggleBtn = document.getElementById('toggleUsers');
toggleBtn.onclick = () => document.getElementById('users').classList.toggle('show');

// Auth form switches
function showRegister(){ document.getElementById('loginForm').style.display='none'; document.getElementById('registerForm').style.display='flex'; }
function showLogin(){ document.getElementById('loginForm').style.display='flex'; document.getElementById('registerForm').style.display='none'; }

// Login form
document.getElementById('loginForm').onsubmit = async e=>{
  e.preventDefault();
  const username=document.getElementById('loginUsername').value;
  const password=document.getElementById('loginPassword').value;
  const res=await fetch('http://localhost:5000/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
  const data=await res.json();
  if(res.status!==200) return alert(data.msg||'Login failed');
  currentUser=data;
  document.getElementById('auth').style.display='none';
  socket.emit('register_user', currentUser._id);
  loadUsers();
}

// Register form
document.getElementById('registerForm').onsubmit = async e=>{
  e.preventDefault();
  const username=document.getElementById('regUsername').value;
  const password=document.getElementById('regPassword').value;
  const gender=document.getElementById('regGender').value;
  const state=document.getElementById('regState').value;
  const res=await fetch('http://localhost:5000/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password,gender,state})});
  const data=await res.json();
  if(res.status!==200) return alert(data.msg||'Registration failed');
  alert('Registration successful! Please login.');
  showLogin();
}

// Load users
async function loadUsers(){
  const res = await fetch(`http://localhost:5000/users/${currentUser._id}?state=${currentUser.state}`);
  users = await res.json();
  renderUsers();
}

function renderUsers(){
  const usersDiv = document.getElementById('users');
  usersDiv.innerHTML='<h2>Contacts</h2>';
  users.forEach(u=>{
    const div=document.createElement('div');
    div.className='user';
    div.innerHTML=`
      <div class="info">
        <span class="username">${u.username}</span>
        <span class="state">${u.gender} ${u.online?'â€¢ Online':''}</span>
      </div>
      <div>
        ${u.unreadCount?`<span class="unread">${u.unreadCount}</span>`:''}
        ${u.online?'<span class="online"></span>':''}
      </div>`;
    div.onclick=()=>selectUser(u);
    usersDiv.appendChild(div);
  });
}

async function selectUser(user){
  selectedUser=user;
  document.getElementById('messages').innerHTML='';
  const res=await fetch(`http://localhost:5000/messages/${currentUser._id}/${user._id}`);
  const msgs=await res.json();
  msgs.forEach(addMessage);
  await fetch(`http://localhost:5000/messages/read/${currentUser._id}/${user._id}`,{method:'PUT'});
  user.unreadCount=0;
  renderUsers();
  socket.emit('mark_as_read',{senderId:user._id,receiverId:currentUser._id});
}

function addMessage(msg){
  const div=document.createElement('div');
  div.className='message '+(msg.sender===currentUser._id?'sent':'received');
  div.innerHTML=`${msg.message}<div class="timestamp">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}

// Send message
const messageInput=document.getElementById('messageInput');
document.getElementById('sendBtn').onclick=sendMessage;
messageInput.onkeypress=()=>{ if(selectedUser) socket.emit('typing',{from:currentUser._id,to:selectedUser._id}); }
function sendMessage(){
  const text=messageInput.value;
  if(!text || !selectedUser) return;
  messageInput.value='';
  fetch('http://localhost:5000/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({senderId:currentUser._id,receiverId:selectedUser._id,message:text})})
  .then(res=>res.json()).then(msg=>{
    addMessage(msg);
    socket.emit('send_message',{senderId:currentUser._id,receiverId:selectedUser._id,message:text});
  });
}

// Socket events
socket.on('new_message', msg=>{
  if(selectedUser && msg.sender===selectedUser._id){
    addMessage(msg);
    socket.emit('mark_as_read',{senderId:selectedUser._id,receiverId:currentUser._id});
  } else {
    const u=users.find(u=>u._id===msg.sender);
    if(u) u.unreadCount=(u.unreadCount||0)+1;
    renderUsers();
  }
});

socket.on('user_list_update', onlineIds=>{
  users.forEach(u=>u.online=onlineIds.includes(u._id));
  renderUsers();
});

socket.on('messages_read', ({from})=>{
  const u=users.find(u=>u._id===from);
  if(u) u.unreadCount=0;
  renderUsers();
});

// Typing indicator
let typingTimeout;
socket.on('typing', ({from})=>{
  const u=users.find(u=>u._id===from);
  if(selectedUser && selectedUser._id===from){
    document.getElementById('typing').innerText=`${u.username} is typing...`;
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>{document.getElementById('typing').innerText='';},2000);
  }
});
</script>
</body>
</html>
